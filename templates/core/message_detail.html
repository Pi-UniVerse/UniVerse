{% extends 'base.html' %}
{% load static %}

{% block title %}{{ other_user.username }} - Messages{% endblock %}

{% block body_class %}messages-page-body{% endblock %}

{% block extra_css %}
<style>
    /* Remove body padding */
    body {
        padding-top: var(--navbar-height);
    }
	
	body.messages-page-body {
		overflow: hidden;
	}

    
    /* Messages layout */
	.messages-page {
		display: grid;
		grid-template-columns: 380px 1fr;
		height: calc(100vh - var(--navbar-height));
		max-width: 1920px;
		margin: 0 auto;
		background: var(--bg-primary);
		overflow: hidden;
	}
    
    /* ========== LEFT SIDEBAR - CHAT LIST ========== */
    .chats-sidebar {
        background: white;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    /* Sidebar header */
    .chats-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
    }
    
    .chats-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }
    
    /* Search bar */
    .chat-search {
        position: relative;
    }
    
    .chat-search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1rem;
    }
    
    .chat-search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 2px solid var(--border);
        border-radius: var(--radius-full);
        font-size: 0.9375rem;
        transition: var(--transition);
        background: var(--bg-primary);
    }
    
    .chat-search-input:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
    }
    
    /* Chat list */
    .chats-list {
        flex: 1;
        overflow-y: auto;
    }
    
    .chat-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.5rem;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        color: inherit;
        border-left: 3px solid transparent;
    }
    
    .chat-item:hover {
        background: var(--bg-primary);
    }
    
    .chat-item.active {
        background: rgba(99, 102, 241, 0.08);
        border-left-color: var(--primary);
    }
    
    .chat-avatar {
        position: relative;
        flex-shrink: 0;
    }
    
    .chat-avatar img {
        width: 52px;
        height: 52px;
        border-radius: var(--radius-full);
        object-fit: cover;
    }
    
    .chat-avatar-placeholder {
        width: 52px;
        height: 52px;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.25rem;
    }
    
    .chat-online-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 14px;
        height: 14px;
        background: var(--success);
        border: 3px solid white;
        border-radius: var(--radius-full);
    }
    
    .chat-info {
        flex: 1;
        min-width: 0;
    }
    
    .chat-top {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 0.25rem;
    }
    
    .chat-name {
        font-weight: 700;
        font-size: 0.9375rem;
        color: var(--text-primary);
    }
    
    .chat-time {
        font-size: 0.75rem;
        color: var(--text-muted);
        white-space: nowrap;
    }
    
    .chat-preview {
        font-size: 0.875rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* ========== MAIN CHAT WINDOW ========== */
    .chat-window {
        display: flex;
        flex-direction: column;
        background: var(--bg-secondary);
        height: 100%;
        position: relative;
    }
    
    /* Chat header */
    .chat-window-header {
        background: white;
        border-bottom: 1px solid var(--border);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 10;
        flex-shrink: 0;
    }
    
    .chat-user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        text-decoration: none;
        color: inherit;
    }
    
    .chat-user-avatar {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-full);
        object-fit: cover;
    }
    
    .chat-user-avatar-placeholder {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.125rem;
    }
    
    .chat-user-details {
        flex: 1;
    }
    
    .chat-user-name {
        font-weight: 700;
        font-size: 1rem;
        color: var(--text-primary);
    }
    
    .chat-user-status {
        font-size: 0.8125rem;
        color: var(--success);
        font-weight: 600;
    }
    
    .chat-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .chat-action-btn {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        background: var(--bg-primary);
        border: none;
        color: var(--text-secondary);
        font-size: 1.125rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }
    
    .chat-action-btn:hover {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }
    
    /* Messages area */
    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: #f9fafb;
    }
    
    /* Date divider */
    .date-divider {
        text-align: center;
        margin: 1.5rem 0 1rem 0;
    }
    
    .date-label {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        background: rgba(0, 0, 0, 0.05);
        border-radius: var(--radius-full);
        font-size: 0.8125rem;
        color: var(--text-muted);
        font-weight: 600;
    }
    
    /* Message bubble */
    .message-bubble {
        display: flex;
        gap: 0.625rem;
        max-width: 70%;
        align-items: flex-end;
        margin-bottom: 0.5rem;
    }
    
    .message-bubble.sent {
        margin-left: auto;
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-full);
        object-fit: cover;
        flex-shrink: 0;
    }
    
    .message-avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.875rem;
        flex-shrink: 0;
    }
    
    .message-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .message-text {
        padding: 0.75rem 1rem;
        border-radius: 1.125rem;
        word-wrap: break-word;
        white-space: pre-wrap;
        font-size: 0.9375rem;
        line-height: 1.5;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .message-bubble.received .message-text {
        background: white;
        color: var(--text-primary);
        border-bottom-left-radius: 0.25rem;
    }
    
    .message-bubble.sent .message-text {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }
    
    .message-time {
        font-size: 0.6875rem;
        color: var(--text-muted);
        padding: 0 0.5rem;
    }
    
    .message-bubble.sent .message-time {
        text-align: right;
    }
    
    /* Input area */
    .chat-input-area {
        background: white;
        border-top: 1px solid var(--border);
        padding: 1rem 1.5rem;
        flex-shrink: 0;
    }
    
    .chat-input-form {
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
    }
    
    .chat-input-wrapper {
        flex: 1;
        position: relative;
    }
    
    .chat-input {
        width: 100%;
        padding: 0.875rem 3rem 0.875rem 1.25rem;
        border: 2px solid var(--border);
        border-radius: 1.5rem;
        font-size: 0.9375rem;
        resize: none;
        font-family: inherit;
        line-height: 1.5;
        max-height: 120px;
        transition: var(--transition);
    }
    
    .chat-input:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    .chat-attach-btn {
        position: absolute;
        right: 0.875rem;
        bottom: 0.875rem;
        width: 32px;
        height: 32px;
        border-radius: var(--radius-full);
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.125rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }
    
    .chat-attach-btn:hover {
        background: var(--bg-primary);
        color: var(--primary);
    }
    
    .chat-send-btn {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-full);
        background: var(--primary);
        border: none;
        color: white;
        font-size: 1.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    
    .chat-send-btn:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
    }
    
    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
        .messages-page {
            grid-template-columns: 320px 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .messages-page {
            grid-template-columns: 1fr;
        }
        
        .chats-sidebar {
            display: none;
        }
        
        .message-bubble {
            max-width: 85%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="messages-page">
    <!-- Left Sidebar - Chat List -->
    <aside class="chats-sidebar">
        <div class="chats-header">
            <h1 class="chats-title">Messages</h1>
            <div class="chat-search">
                <span class="chat-search-icon">🔍</span>
                <input type="text" class="chat-search-input" placeholder="Search conversations...">
            </div>
        </div>
        
		<div class="chats-list">
			{% if conversations %}
				{% for conversation in conversations %}
				<a href="{% url 'message_detail' conversation.other_user.username %}" 
				   class="chat-item {% if conversation.is_active %}active{% endif %}">
					<div class="chat-avatar">
						{% if conversation.other_user.profile.profile_picture %}
							<img src="{{ conversation.other_user.profile.profile_picture.url }}" alt="{{ conversation.other_user.username }}">
						{% else %}
							<div class="chat-avatar-placeholder">{{ conversation.other_user.username|first|upper }}</div>
						{% endif %}
						{% if conversation.is_active %}
							<div class="chat-online-indicator"></div>
						{% endif %}
					</div>
					<div class="chat-info">
						<div class="chat-top">
							<span class="chat-name">{{ conversation.other_user.get_full_name|default:conversation.other_user.username }}</span>
							<span class="chat-time">{{ conversation.last_message.created_at|timesince }} ago</span>
						</div>
						<div class="chat-preview">
							{% if conversation.last_message.sender == user %}
								<span style="font-weight: 600;">You:</span>
							{% endif %}
							{{ conversation.last_message.content|truncatewords:5 }}
						</div>
					</div>
				</a>
				{% endfor %}
			{% else %}
				<div style="padding: 3rem 2rem; text-align: center; color: var(--text-muted);">
					<div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">💬</div>
					<div style="font-weight: 600; margin-bottom: 0.5rem;">No conversations</div>
					<div style="font-size: 0.875rem;">Start a new conversation!</div>
				</div>
			{% endif %}
		</div>
    </aside>
    
    <!-- Main Chat Window -->
    <div class="chat-window">
        <!-- Chat Header -->
        <div class="chat-window-header">
            <a href="{% url 'profile' other_user.username %}" class="chat-user-info">
                {% if other_user.profile.profile_picture %}
                    <img src="{{ other_user.profile.profile_picture.url }}" alt="{{ other_user.username }}" class="chat-user-avatar">
                {% else %}
                    <div class="chat-user-avatar-placeholder">{{ other_user.username|first|upper }}</div>
                {% endif %}
                <div class="chat-user-details">
                    <div class="chat-user-name">{{ other_user.get_full_name|default:other_user.username }}</div>
                    <div class="chat-user-status">Active</div>
                </div>
            </a>
            
            <div class="chat-actions">
                <button class="chat-action-btn" title="Voice call">📞</button>
                <button class="chat-action-btn" title="Video call">📹</button>
                <button class="chat-action-btn" title="More options">⋯</button>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div class="messages-area" id="messagesArea">
            {% regroup messages by created_at.date as messages_by_date %}
            
            {% for date_group in messages_by_date %}
                <div class="date-divider">
                    <span class="date-label">{{ date_group.grouper|date:"F j, Y" }}</span>
                </div>
                
                {% for message in date_group.list %}
                    <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %}">
                        {% if message.sender == user %}
                            <div class="message-content">
                                <div class="message-text">{{ message.content }}</div>
                                <div class="message-time">{{ message.created_at|date:"g:i A" }}</div>
                            </div>
                            {% if user.profile.profile_picture %}
                                <img src="{{ user.profile.profile_picture.url }}" alt="You" class="message-avatar">
                            {% else %}
                                <div class="message-avatar-placeholder">{{ user.username|first|upper }}</div>
                            {% endif %}
                        {% else %}
                            {% if other_user.profile.profile_picture %}
                                <img src="{{ other_user.profile.profile_picture.url }}" alt="{{ other_user.username }}" class="message-avatar">
                            {% else %}
                                <div class="message-avatar-placeholder">{{ other_user.username|first|upper }}</div>
                            {% endif %}
                            <div class="message-content">
                                <div class="message-text">{{ message.content }}</div>
                                <div class="message-time">{{ message.created_at|date:"g:i A" }}</div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-area">
            <form method="post" class="chat-input-form" id="messageForm">
                {% csrf_token %}
                <div class="chat-input-wrapper">
                    <textarea name="content" class="chat-input" placeholder="Type a message..." rows="1" id="messageInput" required></textarea>
                    <button type="button" class="chat-attach-btn" title="Attach file">📎</button>
                </div>
                <button type="submit" class="chat-send-btn" id="sendBtn">
                    ➤
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Auto-scroll to bottom
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
    
    // Auto-resize textarea
    const messageInput = document.getElementById('messageInput');
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Send on Enter (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('messageForm').submit();
        }
    });
    
    // Focus input on load
    messageInput.focus();
</script>
{% endblock %}