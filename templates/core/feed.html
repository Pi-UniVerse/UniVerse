{% extends 'base.html' %}
{% load static %}

{% block title %}Home - UniVerse {% endblock %}

{% block extra_css %}
<style>
    .feed-layout {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
        display: grid;
        grid-template-columns: 280px 1fr 340px;
        gap: 1.5rem;
    }
    
    /* LEFT SIDEBAR - Slim Navigation */
    .left-sidebar {
        position: sticky;
        top: calc(var(--navbar-height) + 1.5rem);
        height: fit-content;
    }
    
    .sidebar-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    
    .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .sidebar-link {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 0.875rem 1rem;
        border-radius: var(--radius);
        text-decoration: none;
        color: var(--text-primary);
        font-weight: 600;
        transition: var(--transition);
    }
    
    .sidebar-link:hover {
        background: var(--bg-primary);
        color: var(--primary);
    }
    
    .sidebar-link.active {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }
    
    .sidebar-link .icon {
        font-size: 1.375rem;
    }
    
    /* CENTER COLUMN - Main Feed */
    .center-feed {
        min-height: 100vh;
    }
    
    /* Stories Section */
    .stories-section {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    
    .stories-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .stories-title {
        font-weight: 700;
        font-size: 1.125rem;
    }
    
    .add-story-link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.875rem;
        transition: var(--transition);
    }
    
    .add-story-link:hover {
        color: var(--primary-dark);
    }
    
    .stories-grid {
        display: flex;
        gap: 0.875rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        scrollbar-width: thin;
    }
    
    .stories-grid::-webkit-scrollbar {
        height: 6px;
    }
    
    .stories-grid::-webkit-scrollbar-track {
        background: var(--bg-primary);
        border-radius: 3px;
    }
    
    .stories-grid::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
    }
    
    .story-item {
        flex-shrink: 0;
        width: 100px;
        text-decoration: none;
        transition: var(--transition);
    }
    
    .story-item:hover {
        transform: translateY(-4px);
    }
    
    .story-avatar {
        width: 100px;
        height: 100px;
        border-radius: var(--radius-lg);
        object-fit: cover;
        border: 3px solid var(--primary);
        box-shadow: var(--shadow);
    }
    
    .story-username {
        font-size: 0.8125rem;
        color: var(--text-secondary);
        margin-top: 0.375rem;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
    }
    
    /* Post Composer */
    .post-composer {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    
    .composer-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .composer-avatar {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-full);
        object-fit: cover;
        border: 2px solid var(--border);
    }
    
    .composer-avatar-placeholder {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.125rem;
    }
    
    .composer-input {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border);
        border-radius: var(--radius-lg);
        font-family: inherit;
        font-size: 1rem;
        resize: none;
        transition: var(--transition);
        min-height: 80px;
    }
    
    .composer-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }
    
    .image-preview-container {
        margin-top: 1rem;
        position: relative;
        display: none;
    }
    
    .image-preview-container.active {
        display: block;
    }
    
    .preview-image {
        width: 100%;
        max-height: 400px;
        object-fit: contain;
        border-radius: var(--radius);
        background: var(--bg-primary);
    }
    
    .remove-image-btn {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        width: 36px;
        height: 36px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: var(--radius-full);
        cursor: pointer;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }
    
    .remove-image-btn:hover {
        background: var(--danger);
        transform: scale(1.1);
    }
    
    .composer-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
        align-items: center;
    }
    
    .composer-btn {
        flex: 1;
        padding: 0.75rem;
        background: var(--bg-primary);
        border: 2px solid transparent;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        color: var(--text-primary);
        text-decoration: none;
        margin: 0;
    }
    
    .composer-btn:hover {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        border-color: var(--primary);
    }
    
    .composer-submit {
        flex: none;
        padding: 0.75rem 2rem;
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    
    .composer-submit:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    
    .composer-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
	/* Enhanced Discover Card */
	.discover-card {
		background: white;
		border-radius: var(--radius-lg);
		padding: 1.25rem;
		box-shadow: var(--shadow);
		border: 1px solid var(--border);
		margin-bottom: 1.5rem;
	}

	.discover-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1rem;
	}

	.discover-title {
		font-weight: 700;
		font-size: 1.125rem;
		color: var(--text-primary);
	}

	.see-all-link {
		color: var(--primary);
		text-decoration: none;
		font-size: 0.875rem;
		font-weight: 600;
		transition: var(--transition);
	}

	.see-all-link:hover {
		color: var(--primary-dark);
	}

	/* Suggested Users */
	.discover-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.discover-item {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		padding: 0.75rem;
		border-radius: var(--radius);
		transition: var(--transition);
	}

	.discover-item:hover {
		background: var(--bg-primary);
	}

	.discover-avatar-link {
		text-decoration: none;
		flex-shrink: 0;
	}

	.discover-avatar-img {
		width: 48px;
		height: 48px;
		border-radius: var(--radius-full);
		object-fit: cover;
		border: 2px solid var(--border);
	}

	.discover-avatar-placeholder {
		width: 48px;
		height: 48px;
		border-radius: var(--radius-full);
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		color: white;
		font-weight: 700;
		font-size: 1.125rem;
	}

	.discover-info {
		flex: 1;
		min-width: 0;
	}

	.discover-name {
		font-weight: 600;
		font-size: 0.9375rem;
		color: var(--text-primary);
		text-decoration: none;
		display: block;
		margin-bottom: 0.125rem;
	}

	.discover-name:hover {
		color: var(--primary);
	}

	.discover-username {
		font-size: 0.8125rem;
		color: var(--text-muted);
	}

	.discover-meta {
		font-size: 0.75rem;
		color: var(--text-muted);
		margin-top: 0.125rem;
	}

	.follow-btn-small {
		padding: 0.5rem 1rem;
		background: var(--primary);
		color: white;
		border: none;
		border-radius: var(--radius-full);
		font-weight: 600;
		font-size: 0.8125rem;
		cursor: pointer;
		transition: var(--transition);
		text-decoration: none;
		display: inline-block;
		white-space: nowrap;
	}

	.follow-btn-small:hover {
		background: var(--primary-dark);
		transform: scale(1.05);
	}

	.empty-suggestions {
		text-align: center;
		padding: 2rem 1rem;
	}

	.empty-icon {
		font-size: 2.5rem;
		margin-bottom: 0.5rem;
		opacity: 0.5;
	}

	.empty-text {
		font-size: 0.875rem;
		color: var(--text-muted);
	}

	/* Quick Links Grid */
	.quick-links-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 0.75rem;
	}

	.quick-link-card {
		padding: 1.25rem;
		border-radius: var(--radius-lg);
		text-decoration: none;
		color: white;
		display: flex;
		flex-direction: column;
		align-items: center;
		text-align: center;
		transition: all var(--transition);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.quick-link-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
	}

	.quick-link-icon {
		font-size: 2rem;
		margin-bottom: 0.5rem;
	}

	.quick-link-name {
		font-weight: 700;
		font-size: 0.9375rem;
		margin-bottom: 0.25rem;
	}

	.quick-link-desc {
		font-size: 0.75rem;
		opacity: 0.9;
	}

	/* Trending */
	.trending-list {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.trending-item {
		display: flex;
		align-items: center;
		gap: 0.875rem;
		padding: 0.75rem;
		border-radius: var(--radius);
		transition: var(--transition);
		cursor: pointer;
	}

	.trending-item:hover {
		background: var(--bg-primary);
	}

	.trending-rank {
		width: 32px;
		height: 32px;
		background: var(--bg-primary);
		border-radius: var(--radius);
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: 800;
		font-size: 0.875rem;
		color: var(--primary);
		flex-shrink: 0;
	}

	.trending-info {
		flex: 1;
	}

	.trending-topic {
		font-weight: 700;
		font-size: 0.9375rem;
		color: var(--text-primary);
		margin-bottom: 0.125rem;
	}

	.trending-count {
		font-size: 0.8125rem;
		color: var(--text-muted);
	}

	/* Sidebar Footer */
	.sidebar-footer {
		padding: 1rem;
		text-align: center;
	}

	.footer-links {
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 0.5rem;
		flex-wrap: wrap;
		margin-bottom: 0.75rem;
		font-size: 0.8125rem;
		color: var(--text-muted);
	}

	.footer-link {
		color: var(--text-muted);
		text-decoration: none;
		transition: var(--transition);
	}

	.footer-link:hover {
		color: var(--primary);
	}

	.footer-copyright {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

    /* Styles for TTS section */
    .tts-section {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 1.5rem;
    }

    .tts-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .tts-title {
        font-weight: 700;
        font-size: 1.125rem;
        color: var(--text-primary);
    }

    .tts-textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--border);
        border-radius: var(--radius);
        font-family: inherit;
        font-size: 0.875rem;
        resize: vertical;
        min-height: 80px;
        margin-bottom: 0.75rem;
        transition: var(--transition);
    }

    .tts-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .tts-button {
        width: 100%;
        padding: 0.75rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .tts-button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .tts-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .tts-player {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--bg-primary);
        border-radius: var(--radius);
        display: none;
    }

    .tts-player.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .tts-audio {
        width: 100%;
        margin-top: 0.5rem;
    }

    /* Styles for STT section */
    .stt-section {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 1.5rem;
    }

    .stt-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .stt-title {
        font-weight: 700;
        font-size: 1.125rem;
        color: var(--text-primary);
    }

    .stt-textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--border);
        border-radius: var(--radius);
        font-family: inherit;
        font-size: 0.875rem;
        resize: vertical;
        min-height: 80px;
        margin-bottom: 0.75rem;
        transition: var(--transition);
    }

    .stt-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .stt-button {
        width: 100%;
        padding: 0.75rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .stt-button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .stt-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .loading-spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .feed-layout {
            grid-template-columns: 1fr 340px;
        }
        
        .left-sidebar {
            display: none;
        }
    }
    
    @media (max-width: 900px) {
        .feed-layout {
            grid-template-columns: 1fr;
        }
        
        .right-sidebar {
            display: none;
        }
    }
	
	/* AI Assistant Styles */
	.ai-suggestion-tag {
		display: inline-block;
		padding: 0.25rem 0.75rem;
		background: rgba(99, 102, 241, 0.1);
		color: var(--primary);
		border-radius: 999px;
		cursor: pointer;
		transition: all var(--transition);
		font-weight: 600;
		font-size: 0.875rem;
	}

	.ai-suggestion-tag:hover {
		background: rgba(99, 102, 241, 0.2);
		transform: scale(1.05);
	}

	.ai-warning {
		animation: pulse 2s ease-in-out infinite;
	}

	@keyframes pulse {
		0%, 100% {
			opacity: 1;
		}
		50% {
			opacity: 0.8;
		}
	}

	.composer-submit:disabled {
		opacity: 0.6;
		cursor: not-allowed;
		transform: none !important;
	}
</style>
{% endblock %}

{% block content %}
<div class="feed-layout">
    <!-- LEFT SIDEBAR -->
    <aside class="left-sidebar">
        <div class="sidebar-card">
            <nav class="sidebar-nav">
                <a href="{% url 'feed' %}" class="sidebar-link active">
                    <span class="icon">🏠</span>
                    <span>Home</span>
                </a>
                <a href="{% url 'messages_list' %}" class="sidebar-link">
                    <span class="icon">💬</span>
                    <span>Messages</span>
                </a>
                <a href="{% url 'profile' user.username %}" class="sidebar-link">
                    <span class="icon">👤</span>
                    <span>Profile</span>
                </a>
                <a href="{% url 'videos_feed' %}" class="sidebar-link">
                    <span class="icon">🎬</span>
                    <span>Media</span>
                </a>
                <a href="{% url 'my_playlists' %}" class="sidebar-link">
                    <span class="icon">📁</span>
                    <span>Playlists</span>
                </a>
                <a href="{% url 'edit_profile' %}" class="sidebar-link">
                    <span class="icon">⚙️</span>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
    </aside>
    
    <!-- CENTER FEED -->
    <main class="center-feed">
        <!-- Stories -->
        {% if story_users %}
        <div class="stories-section">
            <div class="stories-header">
                <h2 class="stories-title">📸 Stories</h2>
                <a href="{% url 'create_story' %}" class="add-story-link">+ Add Story</a>
            </div>
            <div class="stories-grid">
                {% for story_user in story_users %}
                <a href="{% url 'user_stories' story_user.username %}" class="story-item">
                    {% if story_user.latest_story.image %}
                        <img src="{{ story_user.latest_story.image.url }}" class="story-avatar" alt="{{ story_user.username }}">
                    {% elif story_user.latest_story.video %}
                        <video src="{{ story_user.latest_story.video.url }}" class="story-avatar" muted></video>
                    {% elif story_user.latest_story %}
                        {% with bg_color=story_user.latest_story.background_color|default:"linear-gradient(135deg, #667eea, #764ba2)" %}
                        <div class="story-avatar" style="background: {{ bg_color }}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; padding: 1rem; text-align: center; font-size: 0.875rem;">
                            {{ story_user.latest_story.caption|truncatewords:3 }}
                        </div>
                        {% endwith %}
                    {% else %}
                        <div class="story-avatar" style="background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; padding: 1rem; text-align: center; font-size: 0.875rem;">
                            Story
                        </div>
                    {% endif %}
                    <div class="story-username">{{ story_user.username }}</div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Post Composer -->
		<div class="post-composer">
			<form method="post" action="{% url 'create_post' %}" enctype="multipart/form-data" id="postForm">
				{% csrf_token %}
				
				<div class="composer-header">
					{% if user.profile.profile_picture %}
						<img src="{{ user.profile.profile_picture_url }}" alt="{{ user.username }}" class="composer-avatar">
					{% else %}
						<img src="https://ui-avatars.com/api/?name={{ user.username|urlencode }}&size=88&background=667eea&color=fff&bold=true&format=png" 
							 alt="{{ user.username }}" 
							 class="composer-avatar">
					{% endif %}
					<div style="flex: 1;">
						<div style="font-weight: 600; color: var(--text-primary);">{{ user.get_full_name|default:user.username }}</div>
						<div style="font-size: 0.8125rem; color: var(--text-muted);">Share your thoughts...</div>
					</div>
				</div>
				
				<!-- AI Assistant Panel -->
				<div id="aiAssistant" style="display: none; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: var(--radius); border-left: 4px solid var(--primary);">
					<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
						<span style="font-size: 1.25rem;">🤖</span>
						<strong style="color: var(--primary);">AI Assistant</strong>
					</div>
					<div id="aiSuggestions"></div>
				</div>
				
				<textarea name="content" id="postContent" class="composer-input" rows="3" placeholder="What's on your mind, {{ user.get_full_name|default:user.username }}?" required></textarea>
				
				<!-- Image Preview -->
				<div class="image-preview-container" id="imagePreviewContainer">
					<img id="previewImage" class="preview-image" alt="Preview">
					<button type="button" class="remove-image-btn" onclick="removeImage()">×</button>
					<div id="imageCaption" style="position: absolute; bottom: 1rem; left: 1rem; right: 1rem; background: rgba(0, 0, 0, 0.8); color: white; padding: 0.75rem; border-radius: var(--radius); font-size: 0.875rem; display: none;">
						<strong>🤖 AI detected:</strong> <span id="imageCaptionText"></span>
					</div>
				</div>
				
				<input type="file" id="postImage" name="image" accept="image/*" style="display: none;" onchange="previewImageFile(this)">
				
				<div class="composer-actions">
					<label for="postImage" class="composer-btn">
						<span>📷</span>
						<span>Photo</span>
					</label>
					<a href="{% url 'upload_video' %}" class="composer-btn">
						<span>🎬</span>
						<span>Video</span>
					</a>
					<a href="{% url 'create_story' %}" class="composer-btn">
						<span>📸</span>
						<span>Story</span>
					</a>
					<button type="submit" class="composer-btn composer-submit" id="submitBtn">
						<span>📤</span>
						<span>Post</span>
					</button>
				</div>
			</form>
		</div>

        
        <!-- Posts Feed -->
        <div class="posts-feed">
            {% for post in posts %}
                {% include 'core/post_card.html' %}
            {% empty %}
                <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow);">
                    <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">📝</div>
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">No Posts Yet</h3>
                    <p style="color: var(--text-muted);">Be the first to share something!</p>
                </div>
            {% endfor %}
        </div>
    </main>
    
	<!-- RIGHT SIDEBAR - Discover & TTS -->
	<aside class="right-sidebar">
        <!-- Text-to-Speech Section -->
        <div class="tts-section">
            <div class="tts-header">
                <span class="icon">🔊</span>
                <h3 class="tts-title">Text-to-Speech</h3>
            </div>
            
            <textarea 
                id="tts-text" 
                class="tts-textarea" 
                placeholder="Type your text here to convert to audio..."
                rows="4"
            ></textarea>
            
            <button id="tts-button" class="tts-button">
                <span class="button-text">Generate Audio</span>
                <div class="loading-spinner" id="tts-spinner"></div>
            </button>

            <div id="tts-player" class="tts-player">
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                    🔊 Listen:
                </div>
                <audio id="tts-audio" controls class="tts-audio">
                    Your browser does not support the audio element.
                </audio>
            </div>
        </div>

        <!-- Speech-to-Text Section -->
        <div class="stt-section">
            <div class="stt-header">
                <span class="icon">🎤</span>
                <h3 class="stt-title">Speech-to-Text</h3>
            </div>
            
            <button id="recordButton" class="stt-button">
                <span class="button-text">🎤 Start Speaking</span>
            </button>
            
            <div id="recordingStatus" style="display: none; margin: 10px 0; color: var(--primary);">
                🎤 Listening...
            </div>
            
            <textarea 
                id="stt-result" 
                class="stt-textarea" 
                placeholder="Your text will appear here..."
                rows="4"
            ></textarea>
            
            <button id="copyButton" class="stt-button" style="margin-top: 10px; display: none;">
                <span class="button-text">📋 Copy Text</span>
            </button>
            
            <button id="useInPostButton" class="stt-button" style="margin-top: 5px; display: none; background: var(--success);">
                <span class="button-text">📝 Use in Post</span>
            </button>
        </div>

		<!-- Suggested Users -->
		<div class="discover-card">
			<div class="discover-header">
				<h3 class="discover-title">👤 Suggested For You</h3>
				<a href="{% url 'search_users' %}" class="see-all-link">See all</a>
			</div>
			
			<div class="discover-list">
				{% if suggested_users %}
					{% for suggested_user in suggested_users|slice:":3" %}
					<div class="discover-item">
						<a href="{% url 'profile' suggested_user.username %}" class="discover-avatar-link">
							{% if suggested_user.profile.profile_picture %}
								<img src="{{ suggested_user.profile.profile_picture_url }}" 
									 alt="{{ suggested_user.username }}" 
									 class="discover-avatar-img">
							{% else %}
								<img src="https://ui-avatars.com/api/?name={{ suggested_user.username|urlencode }}&size=96&background=667eea&color=fff&bold=true&format=png" 
									 alt="{{ suggested_user.username }}" 
									 class="discover-avatar-img">
							{% endif %}
						</a>
						<div class="discover-info">
							<a href="{% url 'profile' suggested_user.username %}" class="discover-name">{{ suggested_user.get_full_name|default:suggested_user.username }}</a>
							<div class="discover-username">@{{ suggested_user.username }}</div>
							<div class="discover-meta">{{ suggested_user.followers.count }} followers</div>
						</div>
						<a href="{% url 'follow_user' suggested_user.username %}" class="follow-btn-small">Follow</a>
					</div>
					{% endfor %}
				{% else %}
					<div class="empty-suggestions">
						<div class="empty-icon">👥</div>
						<div class="empty-text">Follow more people to get suggestions!</div>
					</div>
				{% endif %}
			</div>
		</div>
		
		<!-- Quick Links -->
		<div class="discover-card">
			<div class="discover-header">
				<h3 class="discover-title">🚀 Explore</h3>
			</div>
			
			<div class="quick-links-grid">
				<a href="{% url 'videos_feed' %}" class="quick-link-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
					<div class="quick-link-icon">🎬</div>
					<div class="quick-link-name">Videos</div>
					<div class="quick-link-desc">Watch & share</div>
				</a>
				
				<a href="{% url 'groups_list' %}" class="quick-link-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
					<div class="quick-link-icon">👥</div>
					<div class="quick-link-name">Groups</div>
					<div class="quick-link-desc">Join communities</div>
				</a>
				
				<a href="{% url 'stories_feed' %}" class="quick-link-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
					<div class="quick-link-icon">📸</div>
					<div class="quick-link-name">Stories</div>
					<div class="quick-link-desc">Share moments</div>
				</a>
				
				<a href="{% url 'my_playlists' %}" class="quick-link-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
					<div class="quick-link-icon">📁</div>
					<div class="quick-link-name">Playlists</div>
					<div class="quick-link-desc">Organize videos</div>
				</a>
			</div>
		</div>
		
		<!-- Trending -->
		<div class="discover-card">
			<div class="discover-header">
				<h3 class="discover-title">🔥 Trending</h3>
			</div>
			
			<div class="trending-list">
				<div class="trending-item">
					<div class="trending-rank">#1</div>
					<div class="trending-info">
						<div class="trending-topic">#TechNews</div>
						<div class="trending-count">1,234 posts</div>
					</div>
				</div>
				
				<div class="trending-item">
					<div class="trending-rank">#2</div>
					<div class="trending-info">
						<div class="trending-topic">#Photography</div>
						<div class="trending-count">892 posts</div>
					</div>
				</div>
				
				<div class="trending-item">
					<div class="trending-rank">#3</div>
					<div class="trending-info">
						<div class="trending-topic">#Travel</div>
						<div class="trending-count">756 posts</div>
					</div>
				</div>
				
				<div class="trending-item">
					<div class="trending-rank">#4</div>
					<div class="trending-info">
						<div class="trending-topic">#Gaming</div>
						<div class="trending-count">623 posts</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Footer Links -->
		<div class="sidebar-footer">
			<div class="footer-links">
				<a href="#" class="footer-link">About</a>
				<span>•</span>
				<a href="#" class="footer-link">Help</a>
				<span>•</span>
				<a href="#" class="footer-link">Privacy</a>
				<span>•</span>
				<a href="#" class="footer-link">Terms</a>
			</div>
			<div class="footer-copyright">
				© 2025 UniVerse 
			</div>
		</div>
	</aside>
</div>

<script>
let typingTimer;
const typingDelay = 1500; // Wait 1.5 seconds after user stops typing

// AI-powered content analysis
document.getElementById('postContent').addEventListener('input', function(e) {
    clearTimeout(typingTimer);
    const text = e.target.value.trim();
    
    if (text.length > 10) {
        typingTimer = setTimeout(() => {
            analyzeContent(text);
        }, typingDelay);
    } else {
        hideAIAssistant();
    }
});

async function analyzeContent(text) {
    console.log('Analyzing text:', text.substring(0, 50) + '...');
    
    try {
        const csrftoken = getCookie('csrftoken');
        console.log('CSRF Token:', csrftoken);
        
        const response = await fetch('/ai/suggestions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ text: text })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('AI response:', data);
        
        if (data.success) {
            displayAISuggestions(data);
        } else {
            console.error('AI returned error:', data.error);
        }
    } catch (error) {
        console.error('AI analysis error:', error);
        // Show error in UI (optional)
        const assistant = document.getElementById('aiAssistant');
        const suggestions = document.getElementById('aiSuggestions');
        suggestions.innerHTML = `
            <div style="padding: 0.75rem; background: #fee2e2; border-radius: var(--radius); font-size: 0.875rem; color: #991b1b;">
                <strong>⚠️ AI unavailable:</strong> ${error.message}
            </div>
        `;
        assistant.style.display = 'block';
    }
}


function displayAISuggestions(data) {
    const assistant = document.getElementById('aiAssistant');
    const suggestions = document.getElementById('aiSuggestions');
    let html = '';
    
    // Sentiment Analysis
    if (data.sentiment) {
        const emoji = data.sentiment.label === 'POSITIVE' ? '😊' : '😐';
        const color = data.sentiment.label === 'POSITIVE' ? '#10b981' : '#6b7280';
        html += `
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: var(--radius); font-size: 0.875rem;">
                <span style="font-size: 1.25rem;">${emoji}</span>
                <strong>Mood:</strong>
                <span style="color: ${color}; font-weight: 600;">${data.sentiment.label}</span>
                <span style="color: var(--text-muted);">(${Math.round(data.sentiment.score * 100)}% confident)</span>
            </div>
        `;
    }
    
    // Toxicity Warning
    if (data.toxicity && data.toxicity.is_toxic && data.toxicity.score > 0.7) {
        html += `
            <div style="padding: 0.75rem; background: #fee2e2; border-radius: var(--radius); font-size: 0.875rem; color: #991b1b; margin-bottom: 0.5rem;">
                <strong>⚠️ Warning:</strong> This content may contain inappropriate language.
                Consider revising before posting.
            </div>
        `;
    }
    
    // Suggested Hashtags
    if (data.hashtags && data.hashtags.length > 0) {
        html += `
            <div style="padding: 0.75rem; background: white; border-radius: var(--radius); font-size: 0.875rem; margin-bottom: 0.5rem;">
                <strong style="color: var(--primary);">💡 Suggested hashtags:</strong>
                <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${data.hashtags.map(tag => `
                        <span onclick="addHashtag('${tag}')" style="background: rgba(99, 102, 241, 0.1); color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 999px; cursor: pointer; transition: all 0.2s; font-weight: 600;" onmouseover="this.style.background='rgba(99, 102, 241, 0.2)'" onmouseout="this.style.background='rgba(99, 102, 241, 0.1)'">${tag}</span>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    if (html) {
        suggestions.innerHTML = html;
        assistant.style.display = 'block';
    } else {
        hideAIAssistant();
    }
}

function addHashtag(tag) {
    const textarea = document.getElementById('postContent');
    const currentText = textarea.value;
    
    // Add hashtag if not already present
    if (!currentText.includes(tag)) {
        textarea.value = currentText + ' ' + tag;
        textarea.focus();
    }
}

function hideAIAssistant() {
    document.getElementById('aiAssistant').style.display = 'none';
}

function previewImageFile(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImg = document.getElementById('previewImage');
            const container = document.getElementById('imagePreviewContainer');
            const captionDiv = document.getElementById('imageCaption');
            const captionText = document.getElementById('imageCaptionText');
            
            previewImg.src = e.target.result;
            container.classList.add('active');
            
            // Show loading state
            captionDiv.style.display = 'block';
            captionText.innerHTML = '<em>🤖 AI analyzing image...</em>';
            
            // Send image to AI for captioning (optional)
            analyzeImageWithAI(input.files[0]);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

async function analyzeImageWithAI(file) {
    try {
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch('/ai/analyze-image/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.caption) {
                const captionText = document.getElementById('imageCaptionText');
                captionText.innerHTML = `<strong>AI detected:</strong> ${data.caption}`;
                
                // Optional: Auto-fill content if empty
                const textarea = document.getElementById('postContent');
                if (!textarea.value.trim()) {
                    textarea.value = `📸 ${data.caption}`;
                }
            }
        }
    } catch (error) {
        console.error('Image analysis error:', error);
        document.getElementById('imageCaption').style.display = 'none';
    }
}


function removeImage() {
    document.getElementById('postImage').value = '';
    document.getElementById('imagePreviewContainer').classList.remove('active');
    document.getElementById('imageCaption').style.display = 'none';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Disable submit button while AI is analyzing (optional)
document.getElementById('postForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span>⏳</span><span>Posting...</span>';
});

// Text-to-Speech Functionality
document.addEventListener('DOMContentLoaded', function() {
    const ttsButton = document.getElementById('tts-button');
    const ttsText = document.getElementById('tts-text');
    const ttsPlayer = document.getElementById('tts-player');
    const ttsAudio = document.getElementById('tts-audio');
    const ttsSpinner = document.getElementById('tts-spinner');
    const buttonText = ttsButton.querySelector('.button-text');

    ttsButton.addEventListener('click', function() {
        const text = ttsText.value.trim();
        
        if (!text) {
            alert("Please enter text to generate audio!");
            ttsText.focus();
            return;
        }

        // Show loading state
        ttsButton.disabled = true;
        buttonText.textContent = 'Generating...';
        ttsSpinner.style.display = 'block';

        // Send request to TTS API
        fetch("/api/text-to-audio/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie('csrftoken')
            },
            body: JSON.stringify({ text: text })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Error generating audio");
            }
            return response.blob();
        })
        .then(blob => {
            // Create audio URL from blob
            const audioUrl = URL.createObjectURL(blob);
            ttsAudio.src = audioUrl;
            
            // Show player
            ttsPlayer.classList.add('active');
            
            // Play automatically
            ttsAudio.play().catch(e => {
                console.log('Auto-play prevented:', e);
            });
        })
        .catch(error => {
            console.error('TTS Error:', error);
            alert("Error generating audio. Please try again.");
        })
        .finally(() => {
            // Reset button state
            ttsButton.disabled = false;
            buttonText.textContent = 'Generate Audio';
            ttsSpinner.style.display = 'none';
        });
    });

    // Clear player when text changes
    ttsText.addEventListener('input', function() {
        if (ttsPlayer.classList.contains('active')) {
            ttsPlayer.classList.remove('active');
            ttsAudio.src = '';
        }
    });

    // Handle audio ended event
    ttsAudio.addEventListener('ended', function() {
        // Optional: do something when audio ends
        console.log('Audio playback finished');
    });

    // Handle audio errors
    ttsAudio.addEventListener('error', function() {
        console.error('Audio playback error');
        alert("Error playing audio.");
    });
});

// =============================================
// SPEECH-TO-TEXT FUNCTIONALITY
// =============================================
class SimpleSpeechToText {
    constructor() {
        this.recognition = null;
        this.isListening = false;
        this.recordButton = document.getElementById('recordButton');
        this.recordingStatus = document.getElementById('recordingStatus');
        this.resultTextarea = document.getElementById('stt-result');
        this.copyButton = document.getElementById('copyButton');
        this.useInPostButton = document.getElementById('useInPostButton');
        
        this.init();
    }
    
    init() {
        // Check browser compatibility
        if (!('webkitSpeechRecognition' in window)) {
            this.recordButton.disabled = true;
            this.recordButton.innerHTML = '<span class="button-text">❌ Microphone not supported</span>';
            return;
        }
        
        // Initialize speech recognition
        this.recognition = new webkitSpeechRecognition();
        this.recognition.continuous = false;
        this.recognition.interimResults = true;
        this.recognition.lang = 'en-US';
        
        // Events
        this.recognition.onstart = () => {
            this.isListening = true;
            this.recordButton.innerHTML = '<span class="button-text">⏹️ Stop</span>';
            this.recordingStatus.style.display = 'block';
            this.resultTextarea.placeholder = "Speak now...";
        };
        
        this.recognition.onend = () => {
            this.isListening = false;
            this.recordButton.innerHTML = '<span class="button-text">🎤 Start Speaking</span>';
            this.recordingStatus.style.display = 'none';
        };
        
        this.recognition.onresult = (event) => {
            let finalTranscript = '';
            let interimTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }
            
            this.resultTextarea.value = finalTranscript || interimTranscript;
            
            // Show buttons if text is present
            if (this.resultTextarea.value.trim()) {
                this.copyButton.style.display = 'block';
                this.useInPostButton.style.display = 'block';
            }
        };
        
        this.recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            if (event.error === 'not-allowed') {
                this.resultTextarea.value = "Error: Microphone access denied";
            } else {
                this.resultTextarea.value = `Error: ${event.error}`;
            }
        };
        
        // Buttons
        this.recordButton.addEventListener('click', () => {
            this.isListening ? this.stopRecording() : this.startRecording();
        });
        
        this.copyButton.addEventListener('click', () => {
            this.copyToClipboard();
        });
        
        this.useInPostButton.addEventListener('click', () => {
            this.useInPost();
        });
    }
    
    startRecording() {
        try {
            this.recognition.start();
        } catch (error) {
            console.error('Start error:', error);
        }
    }
    
    stopRecording() {
        try {
            this.recognition.stop();
        } catch (error) {
            console.error('Stop error:', error);
        }
    }
    
    copyToClipboard() {
        this.resultTextarea.select();
        navigator.clipboard.writeText(this.resultTextarea.value)
            .then(() => {
                const originalText = this.copyButton.innerHTML;
                this.copyButton.innerHTML = '<span class="button-text">✅ Copied!</span>';
                setTimeout(() => {
                    this.copyButton.innerHTML = originalText;
                }, 2000);
            })
            .catch(err => {
                console.error('Copy error:', err);
            });
    }
    
    useInPost() {
        const postContent = document.getElementById('postContent');
        const currentText = postContent.value;
        const newText = this.resultTextarea.value;
        
        if (currentText) {
            postContent.value = currentText + ' ' + newText;
        } else {
            postContent.value = newText;
        }
        
        postContent.focus();
        
        // Visual feedback
        const originalText = this.useInPostButton.innerHTML;
        this.useInPostButton.innerHTML = '<span class="button-text">✅ Added!</span>';
        setTimeout(() => {
            this.useInPostButton.innerHTML = originalText;
        }, 2000);
    }
}

// Initialization
document.addEventListener('DOMContentLoaded', function() {
    // Initialize speech recognition
    if (document.getElementById('recordButton')) {
        new SimpleSpeechToText();
    }
});
</script>

{% endblock %}